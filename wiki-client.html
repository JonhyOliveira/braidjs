<script>
function require (thing) {
    thing = thing.split('/')
    thing = thing[thing.length-1].slice(0,-3)
    console.assert(require[thing], `Thing ${thing} don't exist on ${Object.keys(require)}!`)
    return require[thing]
}
global = window
module = {exports: {}}
</script>
<script src="./utilities.js"></script>
<script src="./events.js"></script>
<script src="./merge-algorithms/sync9.js"></script>
<script src="./node.js"></script>
<script src="./pipe.js"></script>
<script src="./resource.js"></script>
<script src="./networks/websocket-client.js"></script>
<script src="https://invisible-college.github.io/universal-sync/diffsync.js"></script>

<body>
    <textarea id="my_text"></textarea>
</body>

<script>

sync_editor(my_text)

async function sync_editor(t) {
    document.body.append(make_html(`<div id="debug_display">debug text to go here..</div>`))
    document.body.append(make_html(`<textarea id="debug_display2">debug text to go here..</textarea>`))




    var key = '/foo'
    var prev_text = ''
    var node = require('./node.js')({id: 'C-' + Math.random().toString(36).slice(2, 12)})
    require('./networks/websocket-client.js')({node})

    window.my_node = node

    node.ons.push((method, args) => {
        //console.log('RESOURCE: ' + JSON.stringify(node.resource_at(key).space_dag, null, '    '))
        console.log('ABOUT TO: ' + method + ', ' + JSON.stringify(args))
    })

    var setting = 0

    function send_diff(from, to) {
        setting++
        node.set(key, null, diff_convert_to_my_format(diff_main(from, to)).map(x =>
            `.text[${x[0]}:${x[0] + x[1]}] = ${JSON.stringify(x[2])}`
        ))
        setting--

        update_debug_display()
    }

    function send_cursor_update(start, end) {
        // node.set(key, null, [
        //     `.cursors[${JSON.stringify(node.pid + '-start')}] = {"type": "location", "path": ".text[${start}]"}`,
        //     `.cursors[${JSON.stringify(node.pid + '-end')}] = {"type": "location", "path": ".text[${end}]"}`])

        setting++
        node.set(key, null, [`.cursors[${JSON.stringify(node.pid)}] = {"type": "location", "path": ".text[${start}]"}`])
        setting--

        update_debug_display()
    }

    function update_debug_display() {
        var x = node.resource_at(key).mergeable.read()

        debug_display.innerHTML = ''
        for (var i = 0; i < x.text.length; i++) {
            Object.entries(x.cursors).forEach(e => {
                if (e[1] == i) {
                    debug_display.append(make_html(`<span style="color:${e[0] == node.pid ? 'green' : 'red'}">^</span>`))
                }
            })
            var s = make_html(`<span></span>`)
            s.textContent = x.text[i]
            debug_display.append(s)
        }
        Object.entries(x.cursors).forEach(e => {
            if (e[1] == i) {
                debug_display.append(make_html(`<span style="color:${e[0] == node.pid ? 'green' : 'red'}">^</span>`))
            }
        })

        debug_display2.value = JSON.stringify(node.resource_at(key), null, '    ')
    }

    var get_num = 0
    node.get(key, x => {
        if (setting) return

        get_num++
        if (get_num == 1) {
            console.log('got here!!!1111')
            console.assert(node.resource_at(key).weve_been_welcomed === false)
            // ignore, this is the initial value of the new node, which will be null
        } else if (get_num == 2) {
            console.log('got here!!!22222')
            console.assert(node.resource_at(key).weve_been_welcomed === true)

            // Initialize the object if it doesn't have a value yet
            if (!x || typeof(x) !== 'object') node.set(key, {cursors: {}, text: t.value})

            // Or if it does, then prepend it with our text, and send that
            else {
                prev_text = t.value = t.value + x.text
                send_diff(x.text, t.value)
            }

            // Initialize our cursor to it
            send_cursor_update(t.selectionStart, t.selectionEnd)

            // And start sending all future updates
            t.addEventListener('input', e => {
                // debug_display2.value = JSON.stringify(node.resource_at(key), null, '    ')
                send_diff(prev_text, t.value)
                prev_text = t.value
            })
            add_selection_listener(t, send_cursor_update)
        } else {
            console.assert(node.resource_at(key).weve_been_welcomed === true)
            prev_text = t.value = x.text

            // t.setSelectionRange(x.cursors[node.pid + '-start'], x.cursors[node.pid + '-end'])
            t.setSelectionRange(x.cursors[node.pid], x.cursors[node.pid])

            // debug_display.textContent = x.text.slice(0, x.cursors[node.pid + '-start'])
            //    + '^' + x.text.slice(x.cursors[node.pid + '-start'])
            //    + ' :' + x.cursors[node.pid + '-start']

            update_debug_display()
        }
    })
}

print_network = true

function add_selection_listener(t, cb) {
    var prev_start = t.selectionStart
    var prev_end = t.selectionEnd
    
    function handler() {
        if (t.selectionStart != prev_start || t.selectionEnd != prev_end) cb(t.selectionStart, t.selectionEnd)
        prev_start = t.selectionStart
        prev_end = t.selectionEnd
    }
    
    t.addEventListener('mousedown', e => setTimeout(handler, 0))
    t.addEventListener('mouseup', e => setTimeout(handler, 0))
    t.addEventListener('mousemove', e => setTimeout(handler, 0))
    t.addEventListener('input', handler)
    t.addEventListener('keydown', e => setTimeout(handler, 0))
}

function make_html(html) {
    var d = document.createElement('div')
    d.innerHTML = html
    return d.firstChild
}

</script>

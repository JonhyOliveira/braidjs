<script src="./require.js"></script>
<script src="./utilities.js"></script>
<script src="./events.js"></script>
<script src="./merge-algorithms/sync9.js"></script>
<script src="./node.js"></script>
<script src="./pipe.js"></script>
<script src="./resource.js"></script>
<script src="./networks/websocket-client.js"></script>
<script src="https://invisible-college.github.io/universal-sync/diffsync.js"></script>
<script src="https://invisible.college/js/marked.min.js"></script>
<link rel="stylesheet" href="https://invisible.college/css/github-markdown.css">

<body></body>
<script>

document.body.style.border = '3px solid transparent'
var real_errorrr_happened = false
window.onerror = function (e) {
    real_errorrr_happened = true
    document.body.style.border = '4px red solid'
}

var output = document.createElement('div')
output.className = 'pad'
output.style.maxWidth = '900px'
document.body.append(output)

var bottom_pad = document.createElement('div')
bottom_pad.style.height = '50vh'
bottom_pad.style.display = 'none'
document.body.append(bottom_pad)

var t = document.createElement('textarea')
t.style.position = 'fixed'
t.style.bottom = '0px'
t.style.right = '0px'
t.style.width = '100%'
t.style.height = '50vh'
t.style.display = 'none'
t.style.fontSize = '15px'
t.style.fontFamily = 'helvetica, monaco, lucida grande, avenir'
document.body.append(t)

var edit = document.createElement('div')
edit.style.position = 'fixed'
edit.style.bottom = '0px'
edit.style.right = '0px'
edit.style.padding = '30px'
edit.style.cursor = 'pointer'
edit.style.textDecoration = 'underline'
edit.style.backgroundColor = 'rgba(255, 255, 255, .5)'
edit.onclick = toggle_editor
edit.innerText = 'edit'
document.body.append(edit)

var stats = document.createElement('div')
stats.style.position = 'fixed'
stats.style.top = '0px'
stats.style.right = '0px'
stats.style.padding = '30px'
stats.style.backgroundColor = 'rgba(255, 255, 255, .5)'
stats.onclick = toggle_editor
stats.innerText = '_'
document.body.append(stats)

var differ = document.createElement('div')
differ.style.position = 'fixed'
differ.style.bottom = '0px'
differ.style.right = '30px'
differ.style.fontSize = '10px'
differ.style.cursor = 'pointer'
differ.style.textDecoration = 'underline'
differ.style.backgroundColor = 'rgba(100, 100, 100, .2)'
differ.onclick = (e) => {showing_diff=!showing_diff; update_markdown()}
differ.innerText = 'show diffs'
//document.body.append(differ)

var timer
var render_delay = 100
function update_markdown_later() {
    if (timer) clearTimeout(timer)
    timer = setTimeout(update_markdown, render_delay)
}
function update_markdown() {
    timer = null
    var source = showing_diff ? html_diffed(last_version||'', t.value) : t.value
    output.innerHTML = marked(source, {sanitize: !is_safe})
    document.body.className = 'nopad'
}
update_markdown()

var is_safe = window.location.href.match(/^https?:\/\/wiki\./)
var page_key = is_safe ? '/wiki' + window.location.pathname : window.location.pathname

var vert = true, editing = false
function render () {
    t.style.display = editing ? null : 'none'
    bottom_pad.style.display = (editing && vert) ? null : 'none'

    if (vert) {
        t.style.width = '100%'
        t.style.height = '50vh'
        output.style.width = null
    } else {
        t.style.width = '45vw'
        t.style.height = '100%'
        output.style.width = editing ? '55vw' : null
    }

    if (window.node)
        stats.innerText = 'Size: ' + data_size()
}

function data_size() { return Object.keys(node.resource_at(page_key).time_dag).length }

var first_time = true
function toggle_editor () {
    editing = !editing
    render()
    if (editing) t.focus()
    if (editing && first_time) {
        first_time = false
        t.setSelectionRange(0,0)
        t.scrollTop = 0
    }
    update_markdown()
}

document.body.onkeydown = function (e) {
    var mods = 0
    for (k in {ctrlKey:1, shiftKey:1, altKey:1, metaKey:1})
        if (e[k]) mods += 1

    if (e.keyCode == 27
        //|| (mods >= 2 && e.keyCode == 32)
        ) {
        e.stopPropagation()
        toggle_editor()
    }
}

window.onresize = function () {
    var w = window.innerWidth, h = window.innerHeight
    if (w < 1200 !== vert) {
        vert = !vert
        render()
    }
}
onresize()
render()

function handle_pasted_images (el, cb) {
    el.addEventListener("paste", function(e) {
        // 1. Let's look for an image in the clipboard data
        if (!e.clipboardData || !e.clipboardData.items) return
        var items = e.clipboardData.items
        var blob
        for (var i=0; i<items.length; i++) {
            if (items[i].type.indexOf("image") === -1) continue
            blob = items[i].getAsFile()
        }
        if (!blob) return

        // 2. Now we have the pasted image as a blob.  Let's convert it to a data: url
        var reader = new FileReader()
        reader.addEventListener('load', ()=> {cb(reader.result)}, false)
        reader.readAsDataURL(blob)
    }, false)
}
handle_pasted_images(window, x => {
    insert_at_cursor(t, '<img src="'+x+'">')
})

function insert_at_cursor (textarea, string) {
    // IE support
    if (document.selection) {
        textarea.focus()
        sel = document.selection.createRange()
        sel.text = string
    }
    // Mozilla and others
    else if (textarea.selectionStart || textarea.selectionStart == '0') {
        var startPos = textarea.selectionStart
        var endPos = textarea.selectionEnd
        textarea.value = textarea.value.substring(0, startPos)
            + string
            + textarea.value.substring(endPos, textarea.value.length)
    } else
        textarea.value += string;
}

var last_version
var showing_diff = false
addEventListener('keypress', function (e) {
    if (e.ctrlKey && e.key === 's') {
        last_version = t.value
        event.preventDefault()
        update_markdown()
    }
})

color = (s, c) =>
    s.split('\n\n').map(x => '<span style="background-color: '+ c +'">'+ x +'</span>').join('\n\n')

green = (s) => color (s, '#cfc')
red   = (s) => color (s, '#fcc')
function html_diffed (Old, New) {
    var diff = diff_main(Old, New)
    var html = diff.map(
        (x) => x[0] == 1 ? green(x[1])
            : x[0] == -1 ? red(x[1])
            : x[1]
    ).join('')
    //console.log(JSON.stringify(marked(html, {sanitize:false})))
    return html
}


var ting = null
function scroll () {
    // We only scroll to the ting once -- if it's fresh
    if (ting || location.hash.length === 0) return

    ting = document.getElementById(location.hash.substr(1))
    ting && ting.scrollIntoView()
}
for (i=0; i<50; i++)
    setTimeout(scroll, i / 5.0 * 1000)









t.addEventListener('input', e => {
    update_markdown_later()
})

sync_editor(t)
async function sync_editor(t) {
    var prev_text = ''
    window.node = require('./node.js')({id: 'C-' + Math.random().toString(36).slice(2, 12)})
    require('./networks/websocket-client.js')({node, url: 'wss://invisible.college:1492/'})

    node.ons.push((method, args) => {
        //console.log('RESOURCE: ' + JSON.stringify(node.resource_at(key).space_dag, null, '    '))
        console.log('ABOUT TO: ' + method + ', ' + JSON.stringify(args))
    })

    var setting = 0

    function send_diff(from, to) {
        setting++
        node.set(page_key, null, diff_convert_to_my_format(diff_main(from, to)).map(x =>
            `.text[${x[0]}:${x[0] + x[1]}] = ${JSON.stringify(x[2])}`
        ))
        setting--
    }

    function send_cursor_update(start, end) {
        // node.set(key, null, [
        //     `.cursors[${JSON.stringify(node.pid + '-start')}] = {"type": "location", "path": ".text[${start}]"}`,
        //     `.cursors[${JSON.stringify(node.pid + '-end')}] = {"type": "location", "path": ".text[${end}]"}`])

        setting++
        node.set(page_key, null, [`.cursors[${JSON.stringify(node.pid)}] = {"type": "location", "path": ".text[${start}]"}`])
        setting--
    }

    var get_num = 0
    node.get(page_key, x => {
        if (setting) return

        get_num++
        if (get_num == 1) {
            console.log('got here!!!1111')
            console.assert(node.resource_at(page_key).weve_been_welcomed === true)

            // Initialize the object if it doesn't have a value yet
            if (!x || typeof(x) !== 'object') node.set(page_key, {cursors: {}, text: t.value})

            // Or if it does, then prepend it with our text, and send that
            else {
                prev_text = t.value = t.value + x.text
                update_markdown_later()
                send_diff(x.text, t.value)
            }

            // Initialize our cursor to it
            send_cursor_update(t.selectionStart, t.selectionEnd)

            // And start sending all future updates
            t.addEventListener('input', e => {
                send_diff(prev_text, t.value)
                prev_text = t.value

                stats.innerText = 'Size: ' + data_size()
            })
            add_selection_listener(t, send_cursor_update)
        } else {
            console.assert(node.resource_at(page_key).weve_been_welcomed === true)
            prev_text = t.value = x.text
            update_markdown_later()

            // t.setSelectionRange(x.cursors[node.pid + '-start'], x.cursors[node.pid + '-end'])
            t.setSelectionRange(x.cursors[node.pid], x.cursors[node.pid])

            // debug_display.textContent = x.text.slice(0, x.cursors[node.pid + '-start'])
            //    + '^' + x.text.slice(x.cursors[node.pid + '-start'])
            //    + ' :' + x.cursors[node.pid + '-start']
        }

        stats.innerText = 'Size: ' + data_size()
    })
}

function add_selection_listener(t, cb) {
    var prev_start = t.selectionStart
    var prev_end = t.selectionEnd
    
    function handler() {
        if (t.selectionStart != prev_start || t.selectionEnd != prev_end) cb(t.selectionStart, t.selectionEnd)
        prev_start = t.selectionStart
        prev_end = t.selectionEnd
    }
    
    t.addEventListener('mousedown', e => setTimeout(handler, 0))
    t.addEventListener('mouseup', e => setTimeout(handler, 0))
    t.addEventListener('mousemove', e => setTimeout(handler, 0))
    t.addEventListener('input', handler)
    t.addEventListener('keydown', e => setTimeout(handler, 0))
}

</script>

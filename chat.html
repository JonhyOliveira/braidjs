<script type=coffee>
get = bus.fetch
set = bus.save
key = '/chat'
dom.BODY = =>
  chat = get(key)
  submit = =>
    n = chat.val.length
    node.set(key, null,
             "[#{n}:#{n}] = " + JSON.stringify([get('local').new_text || '']))
    bus.save({key: 'local', new_text: ''})

  DIV {},
    H2('messages'),
    for msg in chat.val
      DIV msg
    TEXTAREA
      id:  'the input!'
      key: 'the input!'
      value: get('local').new_text
      onChange: (e) =>
        set({key: 'local', new_text: e.target.value})
      onKeyDown: (e) => if e.keyCode == 13 then setTimeout(submit)
    BUTTON
      onClick: submit
      'Send'
dom.BODY.up = -> document.getElementById('the input!').focus()

bus('/*').to_fetch = (key, t) => node.get(key, (val) => t.done({key, val}))
bus('/*').to_save  = (obj, t) => node.set(obj.key, obj.val)

</script>

<script src="https://stateb.us/client6.js" globals=false server=none></script>


<script src="./require.js"></script>
<script src="./utilities.js"></script>
<script src="./events.js"></script>
<script src="./merge-algorithms/sync9.js"></script>
<script src="./node.js"></script>
<script src="./pipe.js"></script>
<script src="./resource.js"></script>
<!--<script src="./networks/http-client.js"></script>-->
<script src="./networks/websocket-client.js"></script>

<script>
// Create a node
var id = 'C-' + Math.random().toString(36).substr(10)
node = require('./node.js')({id})
node.default('/chat/*', (key) => ['Top post for '+key])
node.default('/chat', ['Top post!'])
require('./networks/websocket-client.js')({node})
print_network = true
</script>